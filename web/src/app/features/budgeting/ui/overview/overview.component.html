@switch (status()) {
	@case ("loading") {
		<div app-skeleton class="budgeting__overview-skeleton-title"></div>
		<div app-skeleton class="budgeting__overview-skeleton-header"></div>
		<div app-skeleton class="budgeting__overview-skeleton-content-transactions"></div>
		<div app-skeleton class="budgeting__overview-skeleton-content-categories"></div>
	}
	@case ("error") {
		<div class="budgeting__overview-error">
			<p>Failed to load budgeting data.</p>
			<button app-button (click)="service.query()">Try again</button>
		</div>
	}
	@case ("success") {
		@let data = service.overview()!;

		<div class="budgeting__overview-content-header">
			<h2
				class="budgeting__overview-content-header-title"
				[style.color]="data.monthBalance >= 0 ? 'var(--text-success)' : 'var(--text-error)'">
				{{ data.monthBalance | currency: data.currency : "symbol" : "1.2-2" }}
			</h2>
			<div class="budgeting__overview-content-header-info">
				<span>Income:</span>
				<b [style.color]="'var(--text-success)'">+{{ data.monthIncome | currency: data.currency }}</b>
				<span>Spending:</span>
				<b [style.color]="'var(--text-error)'">-{{ data.monthSpending | currency: data.currency }}</b>
			</div>
			<span class="budgeting__overview-content-header-month">for {{ transformMonth(data.month) }}</span>
		</div>
		<div class="budgeting__overview-content">
			<h2 class="budgeting__overview-content-card-title">Transactions</h2>
			@for (tx of recentTransactions(); track tx.id) {
				<ng-container *ngTemplateOutlet="row; context: { $implicit: tx, currency: data.currency }" />
			}
			<div app-expand class="budgeting__overview-content-expand" [expanded]="transactionsExpanded">
				@for (tx of restTransactions(); track tx.id) {
					<ng-container *ngTemplateOutlet="row; context: { $implicit: tx, currency: data.currency }" />
				}
			</div>
			@if (!!restTransactions()?.length) {
				<button
					app-button
					class="budgeting__overview-content-expand-button"
					[fill]="'none'"
					(click)="transactionsExpanded = !transactionsExpanded">
					{{ transactionsExpanded ? "Show less" : "Show more (" + restTransactions()?.length + ")" }}
				</button>
			}
		</div>
		<div class="budgeting__overview-content">
			<h2 class="budgeting__overview-content-card-title">Categories breakdown</h2>
			<span class="budgeting__overview-content-card-subtitle">{{ transformMonth(currentMonthIndex()) }}</span>

			<div class="budgeting__category-list">
				@let maxVal = monthlyCategoriesRanking()[0]?.value ?? 1;

				@for (item of initialCategoriesRanking(); track item.name) {
					<ng-container
						*ngTemplateOutlet="category; context: { $implicit: item, max: maxVal, index: $index }" />
				}
				<div app-expand class="budgeting__overview-content-expand" [expanded]="categoriesRankingExpanded">
					@for (item of restCategoriesRanking(); track item.name) {
						<ng-container
							*ngTemplateOutlet="
								category;
								context: { $implicit: item, max: maxVal, index: $index + 5 }
							" />
					}
				</div>
				@if (!!restCategoriesRanking()?.length) {
					<button
						app-button
						class="budgeting__overview-content-expand-button"
						[fill]="'none'"
						(click)="categoriesRankingExpanded = !categoriesRankingExpanded">
						{{
							categoriesRankingExpanded
								? "Show less"
								: "Show more (" + restCategoriesRanking()?.length + ")"
						}}
					</button>
				}
			</div>
		</div>
	}
}

<div class="budgeting__overview-content">
	@if (status() === "success" && monthlyBreakdownData() && monthlyBreakdownOptions()) {
		<h2 class="budgeting__overview-content-card-title">Monthly breakdown</h2>
		<span class="budgeting__overview-content-card-subtitle">{{ transformMonth(currentMonthIndex()) }}</span>
		<div
			app-chart
			class="budgeting__overview-chart"
			type="doughnut"
			[config]="monthlyBreakdownData()!"
			[options]="monthlyBreakdownOptions()!"></div>
	} @else if (status() === "loading") {
		<div app-skeleton class="budgeting__overview-skeleton-content-chart"></div>
	}
</div>

<div class="budgeting__overview-content">
	@if (status() === "success" && yearlyOverviewData() && yearlyOverviewOptions()) {
		<h2 class="budgeting__overview-content-card-title">Yearly overview</h2>
		<span class="budgeting__overview-content-card-subtitle">{{ yearlyOverviewDataYear() }}</span>
		<div
			app-chart
			class="budgeting__overview-chart"
			type="bar"
			[config]="yearlyOverviewData()!"
			[options]="yearlyOverviewOptions()!"></div>
	} @else if (status() === "loading") {
		<div app-skeleton class="budgeting__overview-skeleton-content-chart"></div>
	}
</div>

<div class="budgeting__overview-content">
	@if (status() === "success" && yearlyTrendsData() && yearlyTrendsOptions()) {
		<h2 class="budgeting__overview-content-card-title">Yearly trends</h2>
		<span class="budgeting__overview-content-card-subtitle">{{ yearlyOverviewDataYear() }}</span>
		<div
			app-chart
			class="budgeting__overview-chart-trends"
			type="bar"
			[config]="yearlyTrendsData()!"
			[options]="yearlyTrendsOptions()!"></div>
	} @else if (status() === "loading") {
		<div app-skeleton class="budgeting__overview-skeleton-content-chart-trends"></div>
	}
</div>

<ng-template #row let-tx let-curr="currency">
	<div class="budgeting__overview-content-row">
		<div class="budgeting__overview-content-col">
			<span class="budgeting__overview-content-col-description">
				<span>[{{ tx.category }}]</span>
				<span>{{ tx.description }}</span>
			</span>
			<span class="date-label">{{ tx.date * 1000 | date: "MMMM d, y, EEEE" }}</span>
		</div>
		<span class="budgeting__overview-content-col-amount" [class.income]="tx.isIncome">
			{{ tx.isIncome ? "+" : "-" }} {{ tx.amount | currency: curr : "symbol" : "1.2-2" }}
		</span>
	</div>
</ng-template>

<ng-template #category let-item let-max="max" let-index="index">
	<div class="budgeting__category-list-row">
		<div class="budgeting__category-list-info">
			<div class="budgeting__category-list-info-main">
				<span>[{{ item.name }}]</span>
				<span>{{ item.percentage | number: "1.1-1" }}%</span>
			</div>
			<span class="budgeting__category-info-category-value">
				{{ item.value | currency: service.overview()?.currency : "symbol" : "1.2-2" }}
			</span>
		</div>
		<div class="budgeting__category-bar-container">
			<div
				class="budgeting__category-bar"
				[style.width.%]="item.percentage"
				[style.background-color]="'var(--chart' + ((index % 20) + 1) + ')'"></div>
		</div>
	</div>
</ng-template>
